<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>着物コーデ一覧</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>着物コーデ一覧</h1>

  <!-- 絞り込みメニューを囲む -->
  <div class="filters">

    <!-- カテゴリ選択 -->
    <div class="filter-item">
      <label for="category">カテゴリ選択：</label>
      <select id="category" onchange="displayItems()">
        <option value="浴衣">浴衣</option>
        <option value="単衣">単衣</option>
        <option value="小紋">小紋</option>
        <option value="銘仙">銘仙</option>
      </select>
    </div>

    <!-- 並べ替え機能 -->
    <div class="filter-item">
      <label for="sortBy">並べ替え：</label>
      <select id="sortBy" onchange="displayItems()">
        <option value="身丈_asc">身長が小さい順</option>
        <option value="身丈_desc">身長が大きい順</option>
      </select>
    </div>

  </div>

  <!-- 選んだカテゴリに応じて画像カードが表示される場所 -->
  <div id="list"></div>


  <!-- ここからJavaScript -->
  <script>

    /* ===== 読み込むJSONファイルの指定 ===== */

    const categoryMap = {
      "浴衣": "yukata.json",
      "単衣": "hitoe.json",
      "小紋": "komon.json",
      "銘仙": "meisen.json"
    };

    /* ===== ページ読み込み時に実行 ===== */
    displayItems();

    /*--------------------------------------
      メイン処理：画面にカードを表示
--------------------------------------*/

    async function displayItems() {

      // カテゴリを取得
      const category = document.getElementById("category").value;

      // 並べ替え基準を取得 デフォルトはasc
      const sortBy = document.getElementById("sortBy").value;

      // 表示エリアに「読み込み中...」と出す
      const list = document.getElementById("list");
      list.innerHTML = "<p>読み込み中...</p>";

      try {

        // カテゴリに対応するJSONデータを取得して配列に格納
        const items = await fetchItems(category);

        // itemsを並べ替えて配列に格納
        const sortedItems = sortItems(items, sortBy);

        // 「読み込み中」を消す
        list.innerHTML = "";

        // sortedItems配列内の各アイテムに対してカードを作る
        sortedItems.forEach(item => {
          // カードを生成
          const card = createCard(item);
          // 生成したカードを「List」要素に追加して画面表示
          list.appendChild(card);
        });

      } catch (error) {
        list.innerHTML = `<p>データの読み込みに失敗しました。</p>`;
        console.error("JSON読み込みエラー:", error);
      }
    }

    /*--------------------------------------
        JSONデータ取得
    --------------------------------------*/
    async function fetchItems(category) {
      // JSONファイルをとってくる
      const response = await fetch(`data/${categoryMap[category]}`);
      return await response.json();
    }

    /*--------------------------------------
        ソート処理
    --------------------------------------*/
    function sortItems(items, sortBy) {
      return items.sort((a, b) => {
        if (sortBy === "身丈_asc") return a["身丈"] - b["身丈"];
        if (sortBy === "身丈_desc") return b["身丈"] - a["身丈"];
      });
    }

    /*--------------------------------------
      HTML生成
  --------------------------------------*/
    // 1つのアイテムに対しての処理
    function createCard(item) {

      // カード用のdiv要素を作成し、クラス名を設定
      const div = document.createElement("div");
      div.className = "card";

      // メイン画像URLを配列に追加
      const imageUrls = [item["画像URL"]];

      // 追加画像があれば順番に配列に追加
      ["パターンb", "パターンc", "パターンd", "パターンe", "パターンf", "パターンg"].forEach(key => {
        if (item[key]) imageUrls.push(item[key]);
      });

      // imageUrlsの各画像URL <img> タグに変換（最初の画像だけ表示）
      // 画像番号を表示
      const imagesHtml = imageUrls.map((url, index) => `
    <img src="${stableUrl(url)}" alt="着物画像" class="kimono-image" style="${index === 0 ? '' : 'display:none'}">
    <div class="image-label">${item["ファイル名"].match(/(\d{3}[a-z]?)/)?.[1] || ''}</div>
  `).join('');

      // 複数枚画像があるかどうかを判定
      const isMultiple = imageUrls.length > 1;

      div.innerHTML = `
    <div class="image-container">
      ${imagesHtml}
      ${isMultiple ? `
        <button class="prev">◀</button>
        <button class="next">▶</button>
      ` : ''}
    </div>
    <details>
      <summary>サイズ詳細</summary>
      <table>
        <tr><th>身丈</th><td>${item["身丈"]}cm</td></tr>
        <tr><th>後幅</th><td>${item["後幅"]}cm</td></tr>
        <tr><th>裄</th><td>${item["裄"]}cm</td></tr>
      </table>
    </details>
    <table>
      <tr><th>推奨身長</th><td>${heightRange(item["身丈"])}</td></tr>
      <tr><th>ヒップサイズ</th><td>${hipSize(item["後幅"])}</td></tr>
    </table>
  `;

      // 複数画像がある場合にスライド機能追加
      if (isMultiple) imageSlider(div, imageUrls);

      return div;
    }
    /*--------------------------------------
        画像のスライド機能追加
    --------------------------------------*/
    function imageSlider(div, imageUrls) {
      const container = div.querySelector(".image-container");
      const images = container.querySelectorAll(".kimono-image");
      let currentIndex = 0;

      const showImage = index => {
        images.forEach((img, i) => {
          img.style.display = i === index ? "" : "none";
        });
      };

      container.querySelector(".prev").addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        showImage(currentIndex);
      });

      container.querySelector(".next").addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % images.length;
        showImage(currentIndex);
      });
    }

    /*--------------------------------------
        ユーティリティ関数
    --------------------------------------*/
    /* ===== URL変換 ===== */
    function stableUrl(originalUrl) {

      // 「id=...」の部分を正規表現で取り出す
      const match = originalUrl.match(/id=([^&]+)/);

      // IDが取れたら画像用URLに変換、失敗したら元のURLを返す
      return match ? `https://lh3.googleusercontent.com/d/${match[1]}` : originalUrl;

    }

    /* ===== 後幅からヒップサイズを計算 ===== */
    function hipSize(width) {
      const map = {
        27: "84cm以下", 28: "89cm以下", 29: "94cm以下",
        30: "99cm以下", 31: "104cm以下", 32: "109cm以下",
        33: "114cm以下", 34: "119cm以下"
      };

      // 後幅の指定がない場合は「サイズ不明」と返す
      return map[width] || "サイズ不明";
    }

    /* ===== 身丈から推奨身長を計算 ===== */
    function heightRange(mitake) {
      // プラマイ5センチ
      return `${mitake - 5}cm〜${mitake + 5}cm`;
    }

  </script>
</body>

</html>