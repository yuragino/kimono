<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>着物コーデ一覧</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>着物コーデ一覧</h1>

  <!-- 絞り込みメニューを囲む -->
  <div class="filters">

    <!-- カテゴリ選択 -->
    <div class="filter-item">
      <label for="category">カテゴリ選択：</label>
      <select id="category" onchange="displayItems()">
        <option value="浴衣">浴衣</option>
        <option value="単衣">単衣</option>
        <option value="小紋">小紋</option>
        <option value="銘仙">銘仙</option>
      </select>
    </div>

    <!-- 並べ替え機能 -->
    <div class="filter-item">
      <label for="sortBy">並べ替え：</label>
      <select id="sortBy" onchange="displayItems()">
        <option value="身丈_asc">身長が小さい順</option>
        <option value="身丈_desc">身長が大きい順</option>
      </select>
    </div>

  </div>

  <!-- 選んだカテゴリに応じて画像カードが表示される場所 -->
  <div id="list"></div>


  <!-- ここからJavaScript -->
  <script>

    // カテゴリごとに読み込むJSONファイル名を指定
    const categoryMap = {
      "浴衣": "yukata.json",
      "単衣": "hitoe.json",
      "小紋": "komon.json",
      "銘仙": "meisen.json"
    };

    /*--------------------------------------
        サイトに表示できるようURLを変換
    --------------------------------------*/

    function convertToStableUrl(originalUrl) {

      // 「id=...」の部分を正規表現で取り出す
      const match = originalUrl.match(/id=([^&]+)/);

      // IDが取れたら画像用URLに変換、失敗したら元のURLを返す
      return match ? `https://lh3.googleusercontent.com/d/${match[1]}` : originalUrl;

    }

    /*--------------------------------------
        後幅からヒップサイズを計算
    --------------------------------------*/

    function getHipSize(width) {
      const map = {
        27: "84cm以下", 28: "89cm以下", 29: "94cm以下",
        30: "99cm以下", 31: "104cm以下", 32: "109cm以下",
        33: "114cm以下", 34: "119cm以下"
      };

      // 後幅の指定がない場合は「サイズ不明」と返す
      return map[width] || "サイズ不明";
    }

    /*--------------------------------------
     身丈から推奨身長を計算
  --------------------------------------*/

    function getHeightRange(mitake) {
      // プラマイ5センチ
      return `${mitake - 5}cm〜${mitake + 5}cm`;
    }

    /***************************************************************
          アイテムを読み込んで表示する非同期関数
     ***************************************************************/

    async function displayItems() {

      // 今選ばれているカテゴリを取得
      const category = document.getElementById("category").value;

      // 表示エリアに「読み込み中...」と出す
      const list = document.getElementById("list");
      list.innerHTML = "<p>読み込み中...</p>";

      // 並べ替え基準を取得（デフォルトは「身丈_asc」）
      const sortBy = document.getElementById("sortBy").value;

      try {

        // 選ばれたカテゴリに対応するJSONファイルを読み込む
        const jsonData = await fetch(`data/${categoryMap[category]}`);

        // 読み込んだJSONをJavaScriptの配列に変換
        const items = await jsonData.json();

        // 並べ替え
        const sortedItems = items.sort((a, b) => {
          // 身丈を基準に昇順・降順を切り替える
          if (sortBy === "身丈_asc") {
            return a["身丈"] - b["身丈"]; // 昇順
          } else if (sortBy === "身丈_desc") {
            return b["身丈"] - a["身丈"]; // 降順
          }
        });

        // 読み込み中を消して、リストをリセット
        list.innerHTML = "";

        // データがなければ「条件に一致するデータがありません」と表示
        if (sortedItems.length === 0) {
          list.innerHTML = "<p>条件に一致するデータがありません。</p>";
          return;
        }

        // 並べ替えた着物データを1件ずつ取り出して、HTMLでカードとして表示
        sortedItems.forEach(item => {

          // カードの要素を作る
          const div = document.createElement("div");
          div.className = "card";

          // メイン画像を配列に入れる
          const imageUrls = [item["画像URL"]];

          //追加画像を配列に入れる
          ["パターンb", "パターンc", "パターンd", "パターンe", "パターンf", "パターンg"].forEach(key => {
            if (item[key]) imageUrls.push(item[key]);
          });

          // imageUrls にあるすべての画像URLを < img > タグに変換
          // インデックスが0の時のみ表示
          const imagesHtml = imageUrls.map((url, index) => `
          <img src="${convertToStableUrl(url)}" alt="着物画像" class="kimono-image" style="${index === 0 ? '' : 'display:none'}">
          `).join('');

          // 画像が複数枚ある場合は true、そうでなければ false
          const hasMultipleImages = imageUrls.length > 1;

          div.innerHTML = `
    <div class="image-container">
      ${imagesHtml}
      ${hasMultipleImages ? `
        <button class="prev">◀</button>
        <button class="next">▶</button>
      ` : ''}
    </div>
            <details>
              <summary>サイズ詳細</summary>
              <table>
                <tr><th>身丈</th><td>${item["身丈"]}cm</td></tr>
                <tr><th>後幅</th><td>${item["後幅"]}cm</td></tr>
                <tr><th>裄</th><td>${item["裄"]}cm</td></tr>
              </table>
            </details>
            <table>
              <tr><th>推奨身長</th><td>${getHeightRange(item["身丈"])}</td></tr>
              <tr><th>ヒップサイズ</th><td>${getHipSize(item["後幅"])}</td></tr>
            </table>
          `;

          // 作ったカードをリストに追加
          list.appendChild(div);

          // 複数画像があるときだけスライド機能を追加
          if (hasMultipleImages) {
            const container = div.querySelector(".image-container");
            const images = container.querySelectorAll(".kimono-image");

            // 現在表示している画像のインデックス
            let currentIndex = 0;

            // 画像の表示を切り替える関数
            const showImage = index => {
              images.forEach((img, i) => {
                img.style.display = i === index ? "" : "none";
              });
            };

            // 前へボタンが押された時
            container.querySelector(".prev").addEventListener("click", () => {
              currentIndex = (currentIndex - 1 + images.length) % images.length;
              showImage(currentIndex);
            });

            // 次へボタンが押された時
            container.querySelector(".next").addEventListener("click", () => {
              currentIndex = (currentIndex + 1) % images.length;
              showImage(currentIndex);
            });
          }

        });
      } catch (error) {
        list.innerHTML = `<p>データの読み込みに失敗しました。</p>`;
        console.error("JSON読み込みエラー:", error);
      }
    }

    // ページを開いたとき、すぐに表示されるよう呼び出す
    displayItems();

  </script>
</body>

</html>